<!doctype html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Mini Game Đua Xe</title>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            font-family: Inter,Segoe UI,Roboto,Arial;
            background: #111;
            color: #eee;
            display: flex;
            align-items: center;
            justify-content: center
        }

        #gameWrap {
            width: 420px;
            background: #0f1724;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.6);
            overflow: hidden
        }

        header {
            padding: 10px 14px;
            background: linear-gradient(90deg,#0b1220,#08111a);
            display: flex;
            align-items: center;
            justify-content: space-between
        }

            header h1 {
                font-size: 16px;
                margin: 0
            }

        #canvas {
            display: block;
            background: #2b2b2b;
            touch-action: none
        }

        .controls {
            padding: 10px;
            display: flex;
            gap: 8px;
            align-items: center;
            justify-content: space-between
        }

        .btn {
            background: #1f2937;
            color: #fff;
            padding: 8px 12px;
            border-radius: 8px;
            border: none;
            cursor: pointer
        }

        .info {
            font-size: 13px;
            color: #9aa8b2
        }

        .overlay {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none
        }

        .hud {
            position: absolute;
            left: 12px;
            top: 12px;
            color: #dbeafe;
            font-weight: 700;
            text-shadow: 0 1px 0 rgba(0,0,0,0.6)
        }

        .touch-controls {
            display: flex;
            gap: 8px
        }

        .touch-btn {
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.04);
            padding: 10px;
            border-radius: 8px;
            color: #fff
        }

        footer {
            font-size: 12px;
            color: #9aa8b2;
            padding: 10px;
            text-align: center
        }

        @media (max-width:480px) {
            #gameWrap {
                width: 95vw
            }
        }
    </style>
</head>
<body>
    <div id="gameWrap">
        <header>
            <h1>Mini Đua Xe</h1>
            <div class="info">W/A/S/D hoặc ←→ để lái</div>
        </header>

        <div style="position:relative">
            <canvas id="canvas" width="420" height="560"></canvas>
            <div class="hud" id="hud">Score: 0 &nbsp;|&nbsp; Speed: 0</div>
        </div>

        <div class="controls">
            <div>
                <button id="btnStart" class="btn">Start</button>
                <button id="btnPause" class="btn">Pause</button>
                <button id="btnReset" class="btn">Reset</button>
            </div>
            <div class="touch-controls" id="touchControls" style="display:none">
                <button class="touch-btn" data-action="left">◀</button>
                <button class="touch-btn" data-action="accelerate">▲</button>
                <button class="touch-btn" data-action="right">▶</button>
            </div>
            <div style="text-align:right">
                <div style="font-size:13px">Highscore: <span id="high">0</span></div>
            </div>
        </div>

        <footer>Đụng chướng ngại sẽ kết thúc. Làm sao được điểm cao nhất nhé!</footer>
    </div>

    <script>
(function(){
  // Canvas setup
  var canvas = document.getElementById('canvas');
  var ctx = canvas.getContext('2d');
  var W = canvas.width, H = canvas.height;

  // Game state
  var running = false, paused = false;
  var score = 0, high = parseInt(localStorage.getItem('race_high') || '0', 10);
  document.getElementById('high').textContent = high;

  // Road / car config
  var road = {
    x: W * 0.18,
    width: W * 0.64,
    laneCount: 3,
    laneWidth: null,
    lineX: null
  };
  road.laneWidth = road.width / road.laneCount;

  // Player car
  var player = {
    w: 40, h: 70,
    x: W/2 - 20,
    y: H - 110,
    vx: 0,
    speed: 0,
    maxSpeed: 8,
    accel: 0.2,
    decel: 0.25,
    color: '#ff3b3b'
  };

  // Obstacles (other cars)
  var obstacles = [];
  var spawnTimer = 0;
  var spawnInterval = 80; // frames

  // Road lines for pseudo-motion
  var lines = [];
  for(var i=0;i<12;i++){
    lines.push({x: W/2, y: i * (H/6), h: 40});
  }

  // Controls
  var keys = {};
  window.addEventListener('keydown', function(e){ keys[e.key.toLowerCase()] = true; });
  window.addEventListener('keyup', function(e){ keys[e.key.toLowerCase()] = false; });

  // Touch controls (display on small screens)
  var touchControls = document.getElementById('touchControls');
  function isTouchDevice(){ return 'ontouchstart' in window || navigator.maxTouchPoints; }
  if(isTouchDevice()) touchControls.style.display='flex';
  touchControls.addEventListener('pointerdown', function(ev){
    var action = ev.target.getAttribute('data-action');
    if(action==='left') keys['arrowleft']=true, keys['a']=true;
    if(action==='right') keys['arrowright']=true, keys['d']=true;
    if(action==='accelerate') keys['w']=true;
  });
  touchControls.addEventListener('pointerup', function(ev){
    var action = ev.target.getAttribute('data-action');
    if(action==='left') keys['arrowleft']=false, keys['a']=false;
    if(action==='right') keys['arrowright']=false, keys['d']=false;
    if(action==='accelerate') keys['w']=false;
  });

  // Helpers
  function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }
  function rectsCollide(a,b){
    return !(a.x + a.w < b.x || a.x > b.x + b.w || a.y + a.h < b.y || a.y > b.y + b.h);
  }

  // Reset game
  function reset(){
    score = 0;
    obstacles = [];
    spawnTimer = 0;
    player.x = W/2 - player.w/2;
    player.speed = 0;
    running = false;
    paused = false;
    document.getElementById('hud').textContent = 'Score: 0 | Speed: 0';
  }

  // Start
  function start(){
    running = true;
    paused = false;
    lastTime = performance.now();
    requestAnimationFrame(loop);
  }

  // Pause toggle
  function togglePause(){
    paused = !paused;
    if(!paused && running) {
      lastTime = performance.now();
      requestAnimationFrame(loop);
    }
  }

  // Spawn obstacle
  function spawnObstacle(){
    // choose lane 0..laneCount-1
    var lane = Math.floor(Math.random() * road.laneCount);
    var ox = road.x + lane * road.laneWidth + (road.laneWidth - 40)/2;
    var ow = 40, oh = 70;
    var oy = -oh - 10;
    var speed = 2 + Math.random() * 2 + Math.min(score/500, 3);
    obstacles.push({x: ox, y: oy, w: ow, h: oh, speed: speed, color: (Math.random()>0.5? '#1fb6ff':'#ffd166')});
  }

  // Update loop
  var lastTime = 0;
  function loop(t){
    if(!running || paused) return;
    var dt = (t - lastTime) / (1000/60);
    lastTime = t;

    // Controls: left/right
    var steer = 0;
    if(keys['arrowleft'] || keys['a']) steer = -1;
    if(keys['arrowright'] || keys['d']) steer = 1;
    if(keys['arrowleft'] && keys['arrowright']) steer = 0;

    // Acceleration
    if(keys['w'] || keys['arrowup']) player.speed += player.accel;
    else player.speed -= player.decel * 0.6;

    // Brake
    if(keys['s'] || keys['arrowdown']) player.speed -= player.decel;

    player.speed = clamp(player.speed, 0, player.maxSpeed);

    // Lateral velocity
    player.vx += steer * 0.6;
    player.vx *= 0.85;
    player.x += player.vx * (1 + player.speed/6);

    // Keep inside road
    var minX = road.x + 8;
    var maxX = road.x + road.width - player.w - 8;
    player.x = clamp(player.x, minX, maxX);

    // Scroll effect: move obstacles down relative to player speed
    for(var i=0;i<obstacles.length;i++){
      obstacles[i].y += obstacles[i].speed + player.speed * 0.8;
    }

    // Update road lines
    for(var i=0;i<lines.length;i++){
      lines[i].y += 4 + player.speed * 1.2;
      if(lines[i].y > H) lines[i].y = -lines[i].h;
    }

    // Spawn obstacles periodically
    spawnTimer++;
    if(spawnTimer >= spawnInterval){
      spawnTimer = 0;
      // reduce interval as score increases
      spawnInterval = Math.max(40, 80 - Math.floor(score / 100));
      spawnObstacle();
    }

    // Remove off-screen obstacles and increase score
    for(var i=obstacles.length-1;i>=0;i--){
      if(obstacles[i].y > H + 100){
        obstacles.splice(i,1);
        score += 10;
      }
    }

    // Collision detection
    var playerRect = {x: player.x, y: player.y, w: player.w, h: player.h};
    for(var i=0;i<obstacles.length;i++){
      if(rectsCollide(playerRect, obstacles[i])){
        gameOver();
        return;
      }
    }

    // Update HUD
    document.getElementById('hud').textContent = 'Score: ' + score + ' | Speed: ' + Math.round(player.speed);

    // Draw
    draw();

    // Continue loop
    requestAnimationFrame(loop);
  }

  // Draw function
  function draw(){
    // background
    ctx.clearRect(0,0,W,H);
    // surrounding area
    ctx.fillStyle = '#0b0f14';
    ctx.fillRect(0,0,W,H);

    // road
    ctx.fillStyle = '#1f2937';
    ctx.fillRect(road.x, 0, road.width, H);

    // side grass
    ctx.fillStyle = '#0f1724';
    ctx.fillRect(0,0,road.x,H);
    ctx.fillRect(road.x + road.width,0,W - (road.x + road.width),H);

    // lane separators
    ctx.strokeStyle = '#dbeafe';
    ctx.lineWidth = 4;
    ctx.setLineDash([30,20]);
    for(var i=1;i<road.laneCount;i++){
      var lx = road.x + i * road.laneWidth;
      ctx.beginPath();
      ctx.moveTo(lx, 0);
      ctx.lineTo(lx, H);
      ctx.stroke();
    }
    ctx.setLineDash([]);

    // center dashed lines (motion)
    ctx.fillStyle = '#fff';
    for(var i=0;i<lines.length;i++){
      var l = lines[i];
      var laneCenter = W/2 - 2;
      ctx.fillRect(laneCenter - 3, l.y, 6, l.h);
    }

    // draw obstacles
    for(var i=0;i<obstacles.length;i++){
      var o = obstacles[i];
      roundRect(ctx, o.x, o.y, o.w, o.h, 6, o.color || '#ffcc00', '#111');
      // windows
      ctx.fillStyle = 'rgba(255,255,255,0.12)';
      ctx.fillRect(o.x + 6, o.y + 12, o.w - 12, 20);
    }

    // draw player
    roundRect(ctx, player.x, player.y, player.w, player.h, 8, player.color, '#111');
    // player window
    ctx.fillStyle = 'rgba(255,255,255,0.18)';
    ctx.fillRect(player.x + 6, player.y + 12, player.w - 12, 20);
  }

  // rounded rectangle helper
  function roundRect(ctx, x, y, w, h, r, fill, stroke){
    ctx.beginPath();
    ctx.moveTo(x+r, y);
    ctx.arcTo(x+w, y, x+w, y+h, r);
    ctx.arcTo(x+w, y+h, x, y+h, r);
    ctx.arcTo(x, y+h, x, y, r);
    ctx.arcTo(x, y, x+w, y, r);
    ctx.closePath();
    ctx.fillStyle = fill;
    ctx.fill();
    if(stroke){
      ctx.strokeStyle = stroke;
      ctx.stroke();
    }
  }

  // Game Over
  function gameOver(){
    running = false;
    // update highscore
    if(score > high){
      high = score;
      localStorage.setItem('race_high', high);
      document.getElementById('high').textContent = high;
    }

    // show overlay message
    ctx.fillStyle = 'rgba(0,0,0,0.6)';
    ctx.fillRect(0,0,W,H);
    ctx.fillStyle = '#fff';
    ctx.font = 'bold 26px sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('GAME OVER', W/2, H/2 - 20);
    ctx.font = '16px sans-serif';
    ctx.fillText('Score: ' + score, W/2, H/2 + 8);
    ctx.fillText('Nhấn Start để chơi lại', W/2, H/2 + 36);
  }

  // Buttons
  document.getElementById('btnStart').addEventListener('click', function(){
    if(!running){
      reset();
      start();
    } else {
      // if paused, resume; else keep running
      paused = false;
      lastTime = performance.now();
      requestAnimationFrame(loop);
    }
  });
  document.getElementById('btnPause').addEventListener('click', function(){
    togglePause();
  });
  document.getElementById('btnReset').addEventListener('click', function(){
    reset();
    draw();
    // clear overlay if any
  });

  // initial draw
  draw();

  // make canvas responsive (optional)
  function fitCanvas(){
    var wrap = document.getElementById('gameWrap');
    var styleW = wrap.clientWidth;
    var scale = styleW / 420;
    canvas.style.transform = 'scale(' + scale + ')';
    canvas.style.transformOrigin = 'top left';
    // adjust wrapper height
    canvas.parentNode.style.height = (560 * scale) + 'px';
  }
  window.addEventListener('resize', fitCanvas);
  fitCanvas();

})();
    </script>
</body>
</html>
